#!/bin/bash

set -e

JOB_NAME=containerd
RUN_DIR=/var/vcap/sys/run/$JOB_NAME
LOG_DIR=/var/vcap/sys/log/$JOB_NAME
PID_FILEPATH=$RUN_DIR/$JOB_NAME.pid
CONFIG_FILEPATH=/var/vcap/jobs/$JOB_NAME/config/config.toml

export PATH=$PATH:/var/vcap/packages/containerd/bin

create_dirs() {
  mkdir -p $RUN_DIR $LOG_DIR
}

write_pidfile() {
  echo $$ > $PID_FILEPATH
}

start_containerd() {
  exec 1>> $LOG_DIR/stdout
  exec 2>> $LOG_DIR/stderr
  exec containerd -c $CONFIG_FILEPATH
}

stop_containerd() {
  kill "$(cat $PID_FILEPATH)"
  rm -f $PID_FILEPATH
}

case $1 in
  start)
    create_dirs
    write_pidfile
    start_containerd
  ;;

  stop)
    stop_containerd
  ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
  ;;
esac
